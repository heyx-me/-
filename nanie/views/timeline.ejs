<!DOCTYPE html>
<html lang="he" dir="rtl" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= locals.chatName || 'היומן של אלה' %></title>
    
    <script>
        (function() {
            const theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>

    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <!-- Font Awesome 6.5.1 (Fixed missing icons like fa-bottle-water) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Core Palette */
            --primary-pink: #ff9a9e;
            --secondary-pink: #fad0c4;
            --dark-pink: #d81b60;
            
            /* Theme Variables */
            --bg-body: #f7f9fc;
            --bg-card: #ffffff;
            --bg-soft: #fff0f3;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --border-subtle: rgba(0,0,0,0.05);
            --card-shadow: 0 8px 24px rgba(149, 157, 165, 0.08);
            --card-hover-shadow: 0 12px 28px rgba(149, 157, 165, 0.15);
            --navbar-grad-start: var(--primary-pink);
            --navbar-grad-end: var(--secondary-pink);
            --navbar-shadow: 0 2px 10px rgba(255, 154, 158, 0.3);
            
            /* Scrollbar */
            --scroll-track: #f1f1f1;
            --scroll-thumb: #e0e0e0;
            --scroll-thumb-hover: #ccc;
        }

        [data-bs-theme="dark"] {
            --bg-body: #0f1114;
            --bg-card: #1b1e22; 
            --bg-soft: #25161b; 
            --text-main: #e9ecef;
            --text-muted: #adb5bd;
            --border-subtle: rgba(255,255,255,0.08);
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            --card-hover-shadow: 0 12px 28px rgba(0, 0, 0, 0.3);
            --navbar-grad-start: #880e4f; 
            --navbar-grad-end: #ad1457;
            --navbar-shadow: 0 2px 10px rgba(0,0,0,0.4);
            
            --scroll-track: #2c3034;
            --scroll-thumb: #495057;
            --scroll-thumb-hover: #6c757d;
        }

        body {
            font-family: 'Assistant', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Navbar */
        .bg-pink-gradient {
            background: linear-gradient(120deg, var(--navbar-grad-start) 0%, var(--navbar-grad-end) 100%);
            box-shadow: var(--navbar-shadow);
        }
        
        .navbar-brand {
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            letter-spacing: -0.5px;
            color: #fff !important;
        }

        .navbar-brand .icon-container {
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            color: #fff;
        }
        [data-bs-theme="light"] .navbar-brand .icon-container {
            background-color: #fff;
            color: var(--dark-pink);
        }

        /* Cards */
        .card {
            border: none;
            border-radius: 20px;
            background-color: var(--bg-card);
            box-shadow: var(--card-shadow);
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-hover-shadow);
        }
        .card-header {
            border-bottom: 1px solid var(--border-subtle);
            background-color: var(--bg-card);
            padding: 1.25rem 1.5rem;
        }
        
        h1, h2, h3, h4, h5, h6 { color: var(--text-main); }
        .text-muted { color: var(--text-muted) !important; }
        .text-dark { color: var(--text-main) !important; }

        /* Icon Boxes & Colors - CUSTOM THEMES FOR VISIBILITY */
        .icon-box {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-inline-end: 1rem;
        }
        
        /* Light Mode Icons */
        .theme-feeding { background-color: #d1e7dd; color: #146c43; border-left-color: #198754; }
        .theme-sleeping { background-color: #cfe2ff; color: #0a58ca; border-left-color: #0d6efd; }
        .theme-waking { background-color: #fff3cd; color: #997404; border-left-color: #ffc107; }
        .theme-diaper { background-color: #ffebd1; color: #995c04; border-left-color: #fd7e14; }
        .theme-bath { background-color: #cff4fc; color: #087990; border-left-color: #0dcaf0; }
        .theme-other { background-color: #e2e3e5; color: #41464b; border-left-color: #6c757d; }

        /* Dark Mode Icons - Adjusted for POP */
        [data-bs-theme="dark"] .theme-feeding { background-color: #051b11; color: #75b798; border-left-color: #75b798; }
        [data-bs-theme="dark"] .theme-sleeping { background-color: #031633; color: #6ea8fe; border-left-color: #6ea8fe; }
        [data-bs-theme="dark"] .theme-waking { background-color: #332701; color: #ffda6a; border-left-color: #ffda6a; }
        [data-bs-theme="dark"] .theme-diaper { background-color: #331f01; color: #ffad5c; border-left-color: #ffad5c; }
        [data-bs-theme="dark"] .theme-bath { background-color: #032830; color: #6edff6; border-left-color: #6edff6; }
        [data-bs-theme="dark"] .theme-other { background-color: #212529; color: #adb5bd; border-left-color: #adb5bd; }

        /* Event List Items - Compact */
        .event-item {
            padding: 0.5rem 0.75rem;
            border: none;
            border-bottom: 1px solid var(--border-subtle);
            border-left: 3px solid transparent;
            background-color: transparent;
            transition: all 0.2s ease;
            margin-bottom: 1px;
            color: var(--text-main);
        }
        .event-item:last-child { border-bottom: none; }
        .event-item:hover {
            background-color: var(--bg-soft);
        }

        /* Day Group Headers */
        .day-header {
            background-color: var(--bg-soft);
            border-bottom: 2px solid var(--border-subtle);
            padding: 0.4rem 0.75rem;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Dynamic Border Coloring for List Items */
        .event-item.type-feeding { border-left-color: #198754; }
        .event-item.type-sleeping { border-left-color: #0d6efd; }
        .event-item.type-waking_up { border-left-color: #ffc107; }
        .event-item.type-diaper { border-left-color: #fd7e14; }
        .event-item.type-bath { border-left-color: #0dcaf0; }
        .event-item.type-other { border-left-color: #6c757d; }
        
        [data-bs-theme="dark"] .event-item.type-feeding { border-left-color: #75b798; }
        [data-bs-theme="dark"] .event-item.type-sleeping { border-left-color: #6ea8fe; }
        [data-bs-theme="dark"] .event-item.type-waking_up { border-left-color: #ffda6a; }
        [data-bs-theme="dark"] .event-item.type-diaper { border-left-color: #ffad5c; }
        [data-bs-theme="dark"] .event-item.type-bath { border-left-color: #6edff6; }
        [data-bs-theme="dark"] .event-item.type-other { border-left-color: #adb5bd; }

        .item-details-bg {
            background-color: var(--bs-tertiary-bg); 
            border-radius: 8px;
            padding: 0.5rem;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--scroll-track); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--scroll-thumb-hover); }

        /* Badges */
        .hunger-badge {
            background-color: var(--bg-card);
            color: var(--dark-pink);
            border: 1px solid var(--secondary-pink);
            border-radius: 20px;
            padding: 4px 10px;
            font-weight: 700;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        [data-bs-theme="dark"] .hunger-badge {
            background-color: #331d24; 
            border-color: #880e4f;
            color: #ff80ab;
            box-shadow: none;
        }

        .time-ago-badge {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bs-tertiary-bg);
            padding: 2px 8px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <%
    // Updated TypeMap using Semantic Theme Classes
    const typeMap = {
        'feeding': { label: 'האכלה', icon: 'fa-person-breastfeeding', theme: 'theme-feeding' },
        'sleeping': { label: 'שינה', icon: 'fa-bed', theme: 'theme-sleeping' },
        'waking_up': { label: 'התעוררות', icon: 'fa-sun', theme: 'theme-waking' },
        'diaper': { label: 'חיתול', icon: 'fa-baby', theme: 'theme-diaper' },
        'bath': { label: 'מקלחת', icon: 'fa-bath', theme: 'theme-bath' },
        'other': { label: 'אחר', icon: 'fa-note-sticky', theme: 'theme-other' }
    };

    function getEventMeta(type) {
        return typeMap[type] || typeMap['other'];
    }

    // Helper to calculate time ago
    function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " שנים";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " חודשים";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " ימים";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " שעות";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " דקות";
        return "ממש עכשיו";
    }

    const sortedEvents = (events || []).slice().sort((a, b) => b.timestamp - a.timestamp);
    const lastEvent = sortedEvents.length > 0 ? sortedEvents[0] : null;
    %>

    <div class="container pt-3 pb-3">
        <div class="d-flex justify-content-between align-items-end mb-3 border-bottom pb-2">
            <div>
                <h2 class="mb-0 fw-800 text-dark"><%= locals.chatName || 'היומן של אלה' %></h2>
            </div>
            <div class="text-muted small opacity-75 pb-1">
                <i class="far fa-clock me-1"></i>
                <% if (lastEvent) { %>
                    אירוע אחרון: <%= new Date(lastEvent.timestamp).toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'}) %>
                <% } else { %>
                    אין אירועים
                <% } %>
            </div>
        </div>
        <%
        const now = new Date();
        const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        const eventsLast24h = sortedEvents.filter(e => new Date(e.timestamp) >= last24h);
        %>
        <!-- Summary Cards -->
        <div class="row g-3 mb-3">
        <!-- Last Event Card -->
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-body p-3">
                        <div class="row">
                            <% 
                            const lastFeeding = sortedEvents.find(e => e.type === 'feeding');
                            const lastDiaper = sortedEvents.find(e => e.type === 'diaper');
                            
                            const feedMeta = getEventMeta('feeding');
                            const diaperMeta = getEventMeta('diaper');
                            %>
                            <!-- Last Feeding -->
                            <div class="col-6 d-flex align-items-center border-end">
                                <div class="icon-box <%= feedMeta.theme %> me-3">
                                    <i class="fas <%= feedMeta.icon %>"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.7rem;">האכלה אחרונה</h6>
                                    <% if (lastFeeding) { %>
                                        <h4 class="mb-0 fw-bold text-dark time-ago-badge" data-ts="<%= lastFeeding.timestamp %>" style="font-size: 1.1rem; background: none; padding: 0; color: var(--text-main);">...</h4>
                                        <small class="text-muted"><%= new Date(lastFeeding.timestamp).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}) %></small>
                                    <% } else { %>
                                        <h5 class="mb-0 text-muted">-</h5>
                                    <% } %>
                                </div>
                            </div>
                            
                            <!-- Last Diaper -->
                            <div class="col-6 d-flex align-items-center ps-3">
                                <div class="icon-box <%= diaperMeta.theme %> me-3">
                                    <i class="fas <%= diaperMeta.icon %>"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.7rem;">חיתול אחרון</h6>
                                    <% if (lastDiaper) { %>
                                        <h4 class="mb-0 fw-bold text-dark time-ago-badge" data-ts="<%= lastDiaper.timestamp %>" style="font-size: 1.1rem; background: none; padding: 0; color: var(--text-main);">...</h4>
                                        <small class="text-muted"><%= new Date(lastDiaper.timestamp).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}) %></small>
                                    <% } else { %>
                                        <h5 class="mb-0 text-muted">-</h5>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sub-type Breakdown Widget -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-header border-0 pb-0 pt-2 bg-transparent">
                        <h6 class="text-muted text-uppercase fw-bold mb-0" style="font-size: 0.75rem; letter-spacing: 0.5px;">סיכום 24 שעות</h6>
                    </div>
                    <div class="card-body pt-2 pb-2">
                        <div class="row g-2">
                            <%
                            const subStats = {
                                'right_boob': { label: 'צד ימין', icon: 'fa-chevron-right', count: 0, lastTs: 0, theme: 'theme-feeding' },
                                'left_boob': { label: 'צד שמאל', icon: 'fa-chevron-left', count: 0, lastTs: 0, theme: 'theme-feeding' },
                                'bottle': { label: 'בקבוק', icon: 'fa-wine-bottle', count: 0, lastTs: 0, theme: 'theme-feeding' },
                                'poop': { label: 'קקי', icon: 'fa-poop', count: 0, lastTs: 0, theme: 'theme-diaper' },
                                'pee': { label: 'פיפי', icon: 'fa-droplet', count: 0, lastTs: 0, theme: 'theme-diaper' },
                                'pumping': { label: 'שאיבה', icon: 'fa-pump-medical', count: 0, lastTs: 0, theme: 'theme-other' },
                                'bath': { label: 'מקלחת', icon: 'fa-bath', count: 0, lastTs: 0, theme: 'theme-bath' }
                            };

                            eventsLast24h.forEach(e => {
                                const details = (e.details || e.label || '').toLowerCase();
                                const type = e.type || '';
                                const ts = Number(e.timestamp);
                                
                                const checkAndSet = (key) => {
                                    subStats[key].count++;
                                    subStats[key].lastTs = Math.max(subStats[key].lastTs, ts);
                                };

                                // Feeding Sub-types
                                if (details.includes('ימין')) checkAndSet('right_boob');
                                if (details.includes('שמאל')) checkAndSet('left_boob');
                                if (details.includes('בקבוק')) checkAndSet('bottle');
                                
                                // Diaper Sub-types
                                if (details.includes('צואה') || details.includes('קקי')) checkAndSet('poop');
                                if (details.includes('שתן') || details.includes('פיפי')) checkAndSet('pee');
                                
                                // Other
                                if (details.includes('שאיבה')) checkAndSet('pumping');
                                if (type === 'bath' || details.includes('מקלחת')) checkAndSet('bath');
                            });

                            // Display fixed 2x2 grid: Right, Left, Poop, Pee
                            const displayKeys = ['right_boob', 'left_boob', 'poop', 'pee'];
                            
                            displayKeys.forEach(key => {
                            %>
                                <div class="col-6">
                                    <div class="d-flex flex-column align-items-center justify-content-center p-2 rounded-3 border border-subtle h-100 text-center position-relative overflow-hidden" 
                                         style="background-color: var(--bs-tertiary-bg);">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center mb-2 <%= subStats[key].theme %>" 
                                             style="width: 32px; height: 32px; font-size: 0.9rem;">
                                            <i class="fas <%= subStats[key].icon %>"></i>
                                        </div>
                                        <span class="fw-bold text-dark lh-1 mb-1" style="font-size: 1.4rem;"><%= subStats[key].count %></span>
                                        <span class="text-muted small text-truncate w-100 mb-1" style="font-size: 0.75rem; opacity: 0.8;"><%= subStats[key].label %></span>
                                        
                                        <% if (subStats[key].lastTs > 0) { %>
                                            <span class="time-ago-badge" data-ts="<%= subStats[key].lastTs %>" style="font-size: 0.65rem; padding: 2px 8px;">
                                                ...
                                            </span>
                                        <% } else { %>
                                            <span class="text-muted" style="font-size: 0.65rem; opacity: 0.5;">-</span>
                                        <% } %>
                                    </div>
                                </div>
                            <% 
                            }); 
                            %>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-3">
            <!-- Recent Events List -->
            <div class="col-12">
                <div class="card" style="max-height: 70vh;">
                    <div class="card-header py-2">
                        <h5 class="mb-0 fw-bold text-dark" style="font-size: 1rem;"><i class="fas fa-list-ul me-2 text-pink"></i>יומן אירועים</h5>
                    </div>
                    <div class="list-group list-group-flush overflow-auto custom-scrollbar" style="max-height: 65vh;">
                        <% if (sortedEvents.length > 0) { 
                            // Group events by day
                            const eventsByDay = {};
                            sortedEvents.slice(0, 200).forEach(event => {
                                const date = new Date(event.timestamp);
                                const dayKey = date.toLocaleDateString('he-IL', { year: 'numeric', month: '2-digit', day: '2-digit' });
                                if (!eventsByDay[dayKey]) {
                                    eventsByDay[dayKey] = {
                                        date: date,
                                        events: []
                                    };
                                }
                                eventsByDay[dayKey].events.push(event);
                            });

                            const sortedDays = Object.keys(eventsByDay).sort((a, b) => new Date(b) - new Date(a));
                        %>
                            <% sortedDays.forEach(dayKey => { 
                                const dayGroup = eventsByDay[dayKey];
                                const isToday = new Date().toDateString() === dayGroup.date.toDateString();
                                const isYesterday = new Date(Date.now() - 86400000).toDateString() === dayGroup.date.toDateString();
                            %>
                                <!-- Day Header -->
                                <div class="day-header">
                                    <% if (isToday) { %>
                                        היום
                                    <% } else if (isYesterday) { %>
                                        אתמול
                                    <% } else { %>
                                        <%= dayGroup.date.toLocaleDateString('he-IL', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                                    <% } %>
                                    <span class="badge bg-secondary-subtle text-secondary rounded-pill me-2" style="font-size: 0.7rem;">
                                        <%= dayGroup.events.length %> אירועים
                                    </span>
                                </div>

                                <!-- Events for this day -->
                                <% dayGroup.events.forEach(event => { 
                                    const meta = getEventMeta(event.type);
                                %>
                                    <div class="list-group-item event-item type-<%= event.type %> px-2 py-1">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div class="d-flex align-items-center flex-grow-1">
                                                <div class="rounded-circle d-flex align-items-center justify-content-center me-2 <%= meta.theme %>" style="width: 20px; height: 20px; font-size: 0.6rem;">
                                                    <i class="fas <%= meta.icon %>"></i>
                                                </div>
                                                <span class="fw-bold text-dark" style="font-size: 0.8rem;">
                                                    <%= meta.label %>
                                                </span>
                                                <% if (event.details) { %>
                                                    <span class="text-muted ms-2" style="font-size: 0.7rem;">
                                                        - <%= event.details %>
                                                    </span>
                                                <% } %>
                                            </div>
                                            <div class="fw-bold text-muted" style="font-size: 0.75rem;">
                                                <%= new Date(event.timestamp).toLocaleString('he-IL', { hour: '2-digit', minute: '2-digit' }) %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% }); %>
                            <% if (sortedEvents.length > 200) { %>
                                <div class="text-center py-2 text-muted small border-top">
                                    <i class="fas fa-info-circle me-1"></i> מציג 200 מתוך <%= sortedEvents.length %> אירועים אחרונים
                                </div>
                            <% } %>
                        <% } else { %>
                            <div class="text-center py-4 text-muted">
                                <div class="bg-body-tertiary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                    <i class="fas fa-clipboard-list fa-lg text-secondary opacity-50"></i>
                                </div>
                                <h6 class="fw-bold" style="font-size: 0.9rem;">אין אירועים להצגה</h6>
                                <p class="small" style="font-size: 0.8rem;">הנתונים יופיעו כאן כשיכנסו הודעות חדשות</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Data from Server
        const rawEvents = <%- JSON.stringify(events || []) %>;
        
        // --- Client Side Logic ---

        // Auto Refresh Page every 60 seconds
        setTimeout(() => {
            window.location.reload();
        }, 60000);

        function updateTimeAgo() {
            const now = new Date().getTime();
            const elements = document.querySelectorAll('.time-ago-badge');
            
            elements.forEach(el => {
                const tsStr = el.getAttribute('data-ts');
                if (!tsStr) return;
                
                const ts = Number(tsStr);
                if (isNaN(ts) || ts <= 0) {
                    el.innerText = "-";
                    return;
                }

                const diff = Math.floor((now - ts) / 1000); // seconds
                
                let text = "ממש עכשיו";
                
                if (diff < 0) {
                    // Future (clock skew or prediction)
                    text = "עתידי"; 
                } else if (diff >= 60) {
                    const min = Math.floor(diff / 60);
                    if (min < 60) {
                        text = `לפני ${min} דק'`;
                    } else {
                        const hr = Math.floor(min / 60);
                        if (hr < 24) {
                            text = `לפני ${hr} שעות`;
                        } else {
                            const days = Math.floor(hr / 24);
                            text = `לפני ${days} ימים`;
                        }
                    }
                }
                
                // Only update if changed to avoid jitter/reflows (optional optimization)
                if (el.innerText !== text) {
                    el.innerText = text;
                }
            });
        }
        
        // Update time ago immediately and every minute
        updateTimeAgo();
        setInterval(updateTimeAgo, 60000);
    </script>
</body>
</html>