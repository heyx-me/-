# Phase 12 Plan: Backend Memory Isolation

## Goal
Refactor `nanie/agent.mjs` to support multi-tenant memory by introducing `MappingManager` and `StorageManager`, and enforcing strict group selection logic.

## Steps

### 1. Core Infrastructure (TDD)
- [ ] **Create `nanie/managers.mjs`:** Implement `MappingManager` and `StorageManager` classes.
    - `MappingManager`: Load/Save `mappings.json`, provide `getGroup`/`setMapping`.
    - `StorageManager`: Handle directory creation, `GroupLock` (concurrency), and `timeline`/`metadata` I/O.
- [ ] **Create `nanie/managers.test.js`:** Unit tests for the managers.
    - Verify `mappings.json` persistence.
    - Verify concurrent writes to storage are serialized (race condition test).
    - Verify directory creation logic.

### 2. Agent Refactoring
- [ ] **Update `nanie/agent.mjs`:**
    - Import and initialize `MappingManager` and `StorageManager`.
    - Remove legacy `loadCache`/`saveCache` and `SimpleStore` (or adapt `SimpleStore` if it's still needed for Baileys - *Analysis: SimpleStore is for Baileys state, separate from our Logic memory. We should probably keep SimpleStore for Baileys internal session handling but decouple it from our event logic*).
    - **Crucial:** Modify `handleMessage` to perform the "Map Check".
        - If mapped: Load context from `StorageManager`.
        - If unmapped: Send `GROUP_SELECTION_REQUIRED` error.
    - Update `extractEvents` to use the group-specific logic/context.
    - Update `updateTimeline` (the background loop) to iterate over *all* mapped groups? *Wait, the loop currently assumes one group. We need to refactor `updateTimeline` to be triggered by incoming messages OR loop through all active mappings.*
    - **Decision:** For now, loop through all mappings in `MappingManager` inside `updateTimeline`.

### 3. Integration Verification
- [ ] **Update `nanie/agent.test.js`:**
    - Mock the file system (or use temp dirs).
    - Test the full flow:
        - `handleMessage` with unmapped ID -> Returns Error.
        - Manually add mapping.
        - `handleMessage` with mapped ID -> Processed.

### 4. Cleanup
- [ ] Delete `ella_cache.json`.
- [ ] Ensure `nanie/memory/` and `nanie/mappings.json` are in `.gitignore` (if not already covered by general rules).

## Verification Plan
1.  **Unit Tests:** Run `npm test nanie/managers.test.js`.
2.  **Integration Test:** Run `npm test nanie/agent.test.js`.
3.  **Manual Check:** Send a message from the UI (which generates a new UUID). Verify the backend logs "Rejecting unmapped conversation" (or similar).
