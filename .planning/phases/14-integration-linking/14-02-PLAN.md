# Plan: Nanie Sync & State Recovery

## Current State
- **Architecture:** Multi-tenant (Conversations map to WhatsApp Groups).
- **Storage:** `nanie/store.mjs` (Baileys data), `nanie/memory/${groupId}/` (Event timelines).
- **Status:** Agent connects, but users report **stale data** (missing recent messages) and **UI state leakage** (seeing data from previous groups).
- **Recent Fixes:**
    - Frontend: Cleared events/cache on group selection.
    - Backend: Ensured `updateGroupTimeline` always returns data.
    - Routing: Fixed `LIST_GROUPS` routing.

## Observed Issues
1.  **Missing History:** `SimpleStore` has messages up to Feb 6, but WhatsApp has newer ones (Feb 9). The bot is connected but not picking up these missed messages automatically on startup.
2.  **State Consistency:** Despite fixes, there's a suspicion of lingering state or race conditions where "old data" reappears.
3.  **Sync Reliability:** `messages.upsert` events are not firing for historical backfill during startup, only for real-time messages.

## Goal
Reliably sync missed messages from WhatsApp and ensure the UI reflects the *correct* group's data without contamination.

## Research Plan
1.  **Baileys History Fetching:** Investigate how to manually trigger a fetch of the last 50-100 messages for a specific JID using `sock.fetchMessages` (or equivalent) to fill the gap in `SimpleStore`.
2.  **Store Persistence:** Verify if `baileys_store.json` is being updated correctly and if `readFromFile` is loading the *latest* snapshot or overwriting it with stale memory.
3.  **UI Data flow:** Audit the `ConversationContext` -> `AppContent` -> `ChatInterface` flow to ensure `events` state is strictly bound to the active `conversationId`.

## Implementation Plan
1.  **Feature:** Add a "Resync Group" button in the UI (or auto-trigger on link) that calls a backend action `RESYNC_HISTORY`.
2.  **Backend:** Implement `RESYNC_HISTORY`:
    - Call Baileys to fetch recent messages for the group.
    - Update `SimpleStore`.
    - Trigger `updateGroupTimeline` to extract events from these "newly found" old messages.
3.  **Validation:** Verify that after resync, `timeline.json` contains the Feb 9 events.
