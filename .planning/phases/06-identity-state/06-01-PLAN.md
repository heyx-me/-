# Phase 6: Identity & State - Implementation Plan

## Goal
Implement frontend context for User Identity and Thread Routing (`?thread=UUID`), with lazy conversation creation.

## 1. Identity & Routing Logic
- [ ] **ID-01**: Enhanced Identity Management
  - Keep using `localStorage` for `userId`.
  - Add `localStorage` for `last_active_thread`.
- [ ] **ID-02**: URL Parsing & Redirect
  - On load, check URL for `thread=<UUID>`.
  - If missing, check `last_active_thread` and redirect if valid.
  - If `thread=new` or empty, initialize in "New Chat" mode (`conversationId = null`).

## 2. Lazy Conversation Creation
- [ ] **LZ-01**: Refactor `ChatInterface`
  - Handle `conversationId={null}` gracefully (show empty chat, no subscriptions yet).
- [ ] **LZ-02**: Create-on-Send
  - In `sendMessage`:
  - If `conversationId` is null:
    1. Insert new row into `conversations` (title: "New Chat").
    2. Insert row into `conversation_members`.
    3. Update URL to `?thread=<UUID>`.
    4. Proceed to send message.

## 3. UI Updates
- [ ] **UI-01**: Update Address Bar
  - Show "New Chat" when no thread is selected.
  - (Optional) Update title when thread is created.

## 4. Verification
- [ ] **VER-01**: Test "New Chat" Flow (Visit `/?thread=new` -> Send "Hi" -> URL updates -> Msg sent).
- [ ] **VER-02**: Test Persistence (Reload page -> Stays on same thread).
- [ ] **VER-03**: Test Root Redirect (Visit `/` -> Redirects to last thread).
