---
wave: 1
depends_on: []
files_modified:
  - package.json
  - vitest.config.js
  - playwright.config.js
  - rafi/utils/smoke.test.js
  - tests/e2e/smoke.spec.js
autonomous: true
---

# Plan: Infrastructure Setup

## Context
We are retrofitting a test suite into a brownfield project that has zero tests.
The project uses standard ES modules in Node.js for backend and a custom Service Worker transpiler for frontend JSX.
For testing, we will use:
- **Vitest**: For Unit/Integration (fast, compatible with Vite/Rollup logic).
- **Playwright**: For E2E (browser automation).

## Goal
Install and configure the testing harness so that `npm test` and `npm run test:e2e` execute successfully.

## Tasks

<task>
<instruction>
Install development dependencies for testing.
</instruction>
<command>
npm install --save-dev vitest jsdom @testing-library/react @testing-library/jest-dom @playwright/test
</command>
<verification>
Check `package.json` for new devDependencies.
</verification>
</task>

<task>
<instruction>
Create `vitest.config.js` at the root.
Config should:
- Use `jsdom` environment.
- Support JSX (React).
- Alias `@` to `./rafi` if needed (or just handle relative paths).
- Exclude `node_modules` and `tests/e2e` (Playwright tests).
</instruction>
<file_path>vitest.config.js</file_path>
<content>
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'jsdom',
    include: ['rafi/**/*.{test,spec}.{js,jsx}'],
    exclude: ['tests/e2e/**', 'node_modules/**'],
    globals: true,
  },
});
</content>
</task>

<task>
<instruction>
Create `playwright.config.js` at the root.
Config should:
- Look for tests in `tests/e2e`.
- Run a local web server (if possible) or expect one running.
- Use the `server.js` entry point? No, `server.js` serves the app.
- We will configure `webServer` to run `npm start` (which runs `node server.js`).
</instruction>
<file_path>playwright.config.js</file_path>
<content>
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  timeout: 30000,
  webServer: {
    command: 'npm start',
    port: 3000,
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
  use: {
    baseURL: 'http://localhost:3000',
  },
});
</content>
</task>

<task>
<instruction>
Add test scripts to `package.json`.
- `test`: "vitest"
- `test:e2e`: "playwright test"
- `test:ui`: "vitest --ui"
</instruction>
<edit_file>package.json</edit_file>
<change>
Add the scripts to the "scripts" section.
</change>
</task>

<task>
<instruction>
Create a directory for Playwright tests.
</instruction>
<command>
mkdir -p tests/e2e
</command>
</task>

<task>
<instruction>
Create a smoke test for Vitest to verify configuration.
</instruction>
<file_path>rafi/utils/smoke.test.js</file_path>
<content>
import { describe, it, expect } from 'vitest';

describe('Smoke Test', () => {
  it('should pass if Vitest is working', () => {
    expect(true).toBe(true);
  });
});
</content>
</task>

<task>
<instruction>
Create a smoke test for Playwright to verify configuration.
</instruction>
<file_path>tests/e2e/smoke.spec.js</file_path>
<content>
import { test, expect } from '@playwright/test';

test('has title', async ({ page }) => {
  await page.goto('/');
  // Expect a title "to contain" a substring.
  await expect(page).toHaveTitle(/Heyx/);
});
</content>
</task>

## Verification
- [ ] `npm test` runs and passes (1 test).
- [ ] `npm run test:e2e` installs browsers (if needed) and passes (1 test).

## Must Haves
- Vitest config supports JSX (even if we just mocked it for now, we need the config).
- Playwright config launches the local server automatically.
