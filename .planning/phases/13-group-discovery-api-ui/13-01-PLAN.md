# Phase 13 Plan: Group Discovery API & UI

## Goal
Implement the backend logic to list available WhatsApp groups (sorted by activity) and the frontend UI to display them when no group is linked.

## Steps

### 1. Backend: Upgrade Store & API (TDD)
- [ ] **Create `nanie/store.test.js`:**
    - Test `SimpleStore` updates timestamp on `messages.upsert`.
    - Test `SimpleStore` correctly filters and sorts groups.
- [ ] **Update `nanie/agent.mjs`:**
    - Upgrade `SimpleStore` class to track message timestamps.
    - Add `listGroups()` helper method.
    - Handle `action: 'LIST_GROUPS'` in `handleMessage`.
        - Returns `{ type: 'DATA', data: { groups: [...] } }`.

### 2. Frontend: Group Selection UI
- [ ] **Update `nanie/app.jsx`:**
    - Add `GroupSelectionList` component.
    - Update `AppContent` to track `isLinked` state (or `showGroupSelector`).
    - Listen for `type: 'SYSTEM', code: 'GROUP_SELECTION_REQUIRED'`.
    - When triggered:
        - Replace Event List with `GroupSelectionList`.
        - Auto-send `{ action: 'LIST_GROUPS' }`.
    - Handle `type: 'DATA'` with `groups` property.
    - Render the list (Name + Last Activity).

## Verification
1.  **Backend Test:** `npm test nanie/store.test.js`.
2.  **Manual Test:**
    - Reset mappings (delete `nanie/mappings.json` or rename it).
    - Open Nanie App.
    - Verify "Group Selection Required" (or similar UI) appears.
    - Verify list of groups appears (might need to send a message to the bot from a real phone to populate the store if it's empty).
