# Phase 5: Foundation: Schema & Agent - Implementation Plan

## Goal
Establish the database structure (`conversations`, `members`) and update the Agent/App to strictly respect conversation boundaries.

## 1. Database Setup
- [ ] **DB-01**: Clean State
  - Truncate `messages` table.
- [ ] **DB-02**: Schema Creation
  - Create `conversations` table (id, title, owner_id, created_at, updated_at).
  - Create `conversation_members` table (conversation_id, user_id, joined_at).
  - Add Foreign Key constraint to `messages.conversation_id`.
  - Set `messages.conversation_id` to NOT NULL.

## 2. Backend (Agent) Updates
- [ ] **AGT-01**: Context Isolation
  - Update `agent.js` to fetch history using `conversation_id` instead of just `room_id`.
- [ ] **AGT-02**: Reply Handling
  - Ensure `sendReply` inserts messages with the correct `conversation_id`.

## 3. Frontend (App) Updates
- [ ] **APP-01**: Default Conversation Logic
  - On app load, check if a conversation exists for the user.
  - If not, create a "Default" conversation and store its ID.
- [ ] **APP-02**: Message Filtering
  - Update `ChatInterface` to subscribe/fetch messages using `conversation_id`.
- [ ] **APP-03**: Message Sending
  - Update `sendMessage` to include the current `conversation_id`.

## 4. Verification
- [ ] **VER-01**: Test Database Constraints (Try inserting message without conversation_id -> Should Fail).
- [ ] **VER-02**: Test Isolation (Send msg in Thread A, verify Agent in Thread B doesn't see it).
